<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Management</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/file_upload_download.css">
    <link rel="stylesheet" href="../assets/css/file_download_popup.css">
    
</head>
<body>
    <!-- Navbar -->
    <div id="navbar-container"></div>


    <h2>File Upload / Download</h2>

    <!-- Table wrapper to control the border and rounded corners -->
    <div class="table-wrapper">
        <table class="freeze-header">
            <thead>
                <tr>
                    <th>Files</th>
                    <th>Agent Type</th>
                    <th>Upload/Export</th>
                    <th>Reupload</th>
                </tr>
            </thead>
            <tbody>
                <tr class="file-row" data-process="Requirements Form">
                    <td>Scoping Form</td>
                    <td>Sales</td>
                    <td><button class="button" id="req-download">Download File</button></td>
                    <td><button class="button reupload" id="req-reupload">Reupload File</button></td>
                </tr>
                
                <tr class="file-row" data-process="SOW">
                    <td>SOW</td>
                    <td>Sales</td>
                    <td><button class="button" id="sow-upload">Upload File</button></td>
                    <td><button class="button reupload" id="sow-reupload" style="display: none;">Reupload File</button></td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- File Download Popup -->
    <div id="download-popup" class="popup" style="display: none;">
        <div class="popup-content">
            <!-- Close button (X) in the top-right corner -->
            <span id="close-popup" class="close-btn">&times;</span>
            <h3>Choose File Format</h3>
            <button id="download-pdf">Download PDF</button>
            <button id="download-json">Download JSON</button>
        </div>
    </div>

    <!-- Back Button aligned to the right -->
    <button id="back-button" class = "back-button">Back</button>

    <script src="../assets/js/file_upload_download.js"></script> <!-- Link to the external JavaScript file -->
    <script src="../assets/js/table.js"></script>
    <script src="../assets/js/script.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const popup = document.getElementById("download-popup");
            const pdfButton = document.getElementById("download-pdf");
            const jsonButton = document.getElementById("download-json");
            const closeButton = document.getElementById("close-popup");

            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('project_id');
    
            let currentApiUrl = ""; // Store the current API URL for downloading
    
            // Function to open popup
            function openPopup(apiUrl) {
                console.log("Download button clicked");
                currentApiUrl = apiUrl; // Set the current API URL based on the clicked button
                popup.style.display = "block";
            }
    
            // Function to close popup
            function closePopup() {
                console.log("Closing popup");
                popup.style.display = "none";
            }
    
            // PDF download
            pdfButton.addEventListener("click", function () {
                console.log("PDF download clicked");

                const downloadButton = document.getElementById("req-download");
                let file = downloadButton ? "scoping" : "sow";
        

                fetch("http://localhost:5678/webhook-test/e16c6e2f-f583-4b54-ab7d-ba7e1859eb26", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        type: "pdf",
                        project_id: projectId,
                        file: file
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Failed to fetch PDF");
                    }
                    return response.blob(); // Get PDF as a Blob
                })
                .then(blob => {
                    // Create a temporary link to download the PDF
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement("a");
                    link.href = url;
                    link.download = `project_${projectId}.pdf`;
                    document.body.appendChild(link);
                    link.click();
                    link.remove();
                    window.URL.revokeObjectURL(url);
                })
                .catch(error => {
                    console.error("Error downloading PDF:", error);
                    alert("Failed to download PDF.");
                });

                closePopup();
            });



    
            // JSON download - Fetch data from different API based on clicked button
            jsonButton.addEventListener("click", async function () {
                console.log("JSON download clicked");
    
                try {
                    // Fetch data from the appropriate API based on currentApiUrl
                    const response = await fetch(currentApiUrl);
                    console.log("url: ", currentApiUrl);
                    console.log("response:", response);
    
                    // Check if the response is valid
                    if (response.ok) {
                        const data = await response.json();
    
                        const jsonBlob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
                        const link = document.createElement("a");
                        link.href = URL.createObjectURL(jsonBlob);
                        link.download = `project_${projectId}.json`; // Use the endpoint name to name the file
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    } else {
                        console.error("Failed to fetch data from the server.");
                        alert("Failed to download JSON file.");
                    }
                } catch (error) {
                    console.error("Error fetching JSON file:", error);
                    alert("Failed to download JSON file.");
                }
    
                closePopup();
            });
    
            // Close popup event
            closeButton.addEventListener("click", closePopup);
    
            // Attach click event to the "Download File" button for Scoping Form
            const downloadButton = document.getElementById("req-download");
            if (downloadButton) {
                downloadButton.addEventListener("click", function () {
                    console.log("Download button with ID req-download clicked");
                    openPopup("http://localhost:3000/project-details/" + projectId); // Set the API URL for Scoping Form
                });
            }
    
            // Attach click event to the "Upload File" button for SOW
            const uploadButton = document.getElementById("sow-upload");
            if (uploadButton) {
                uploadButton.addEventListener("click", function () {
                    console.log("Upload button with ID sow-upload clicked");
                    openPopup("http://localhost:3000/project-details/" + projectId); // Set the API URL for SOW
                });
            }
    
            // Attach click event to the "Reupload File" button for Scoping Form or SOW
            const reuploadButtons = document.querySelectorAll(".reupload");
            reuploadButtons.forEach(button => {
                button.addEventListener("click", function () {
                    console.log("Reupload button clicked");
    
                    // Create file input dynamically
                    const fileInput = document.createElement("input");
                    fileInput.type = "file";
                    fileInput.accept = ".json"; // Allow only json files
    
                    // When the user selects a file
                    fileInput.addEventListener("change", function (event) {
                        const file = event.target.files[0];
                        if (file) {
                            console.log("Selected file:", file);
    
                            // Handle file upload here (e.g., upload to server)
                            cleanJsonData(file, projectId);
                        }
                    });
    
                    // Trigger file input click to open the file selection dialog
                    fileInput.click();
                });
            });

            function cleanJsonData(file, projectId) {
                const reader = new FileReader();
                
                reader.onload = function(event) {
                    try {
                        const fileContent = event.target.result;
                        let jsonData = JSON.parse(fileContent); // Parse the JSON content
                        console.log("json: ", jsonData)
                        // Clean the JSON data 
                        delete jsonData.project_id;

                        const dateFields = [
                            "previous_testing",
                            "project_start_date",
                            "draft_report_due_date",
                            "final_report_due_date"
                        ];

                        dateFields.forEach(field => {
                            if (jsonData[field]) {
                                // Convert the date string to the required format: YYYY-MM-DD
                                const formattedDate = new Date(jsonData[field]).toISOString().split('T')[0];
                                jsonData[field] = formattedDate;
                            }
                        });
                        console.log("Cleaned Data:", jsonData);

                        // After cleaning, re-upload the file or send the data
                        uploadFile(jsonData, projectId);

                    } catch (error) {
                        console.error("Error reading or parsing JSON file:", error);
                        alert("Error reading or parsing JSON file");
                    }
                };

                reader.onerror = function(error) {
                    console.error("Error reading the file:", error);
                    alert("Error reading the file");
                };

                reader.readAsText(file); // Read the file as text
            }

        

            function uploadFile(file, projectId) {
                const formData = new FormData();

                // Construct the URL
                const uploadApiUrl = `http://localhost:3000/project-details/${projectId}`;
                console.log('Uploading file and data to URL:', uploadApiUrl);

                // Send the request
                fetch(uploadApiUrl, {
                    method: 'PUT',
                    body: JSON.stringify(file),
                    headers: { "Content-Type": "application/json; charset=UTF-8" }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Response from server:', data);
                    alert("Successfully updated!");  // Show popup on success
                })
                .catch(error => {
                    console.error('Error uploading file and data:', error);
                    alert("Update failed. Please try again.");  // Show error popup
                });
            }


        });

        document.getElementById("back-button").addEventListener("click", function() {
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('project_id');
            window.location.href = 'Project_subpage.html?project_id=' + projectId;
        });
    </script>
    
    
    
</body>
</html>
